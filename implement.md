# koteiterm 実装計画

## 実装方針

このドキュメントは、spec.mdで定義された機能を実装する順序とテスト計画を定義します。
段階的に実装し、各ステップで動作確認とテストを行うことで、確実に機能を積み上げていきます。

## 実装の優先順位付け原則

1. **依存関係の解決**: 他の機能の基盤となる機能を優先
2. **早期の動作確認**: できるだけ早く動くものを作り、フィードバックループを回す
3. **リスクの高い部分の早期実装**: 技術的に難しい部分を早めに検証
4. **段階的な機能追加**: 小さく動くものから徐々に機能を追加

## フェーズ1: 最小限の動作確認 (MVP)

### 目標
ウィンドウを開いて、シェルとやり取りできる最小限の機能を実現する。

### ステップ1.1: プロジェクト基盤構築
**実装内容:**
- ディレクトリ構造の作成
- Makefile作成
- 基本的なヘッダファイル (koteiterm.h)
- main.c の基本構造

**成果物:**
- コンパイル可能な最小限のプログラム（何もしないが起動する）

**テスト:**
- `make` でコンパイルが通る
- 実行すると正常に起動・終了する

**実装時間見積もり:** 1-2時間

---

### ステップ1.2: X11ウィンドウ作成
**実装内容:**
- [F3.1] X11ウィンドウの作成と表示
- ウィンドウの基本的なイベント処理（閉じるボタン）
- 固定サイズのウィンドウ (800x600px程度)

**関連ファイル:**
- src/display.c/h: X11初期化、ウィンドウ作成

**テスト:**
- ウィンドウが表示される
- ウィンドウの閉じるボタンで正常に終了する
- X11エラーが発生しない

**実装時間見積もり:** 2-3時間

---

### ステップ1.3: PTY作成とシェル起動
**実装内容:**
- [F2.1] PTYの作成（openpty使用）
- [F2.2] シェルプロセスのfork/exec
- PTYからのデータ読み取り（標準出力）
- PTYへのデータ書き込み（標準入力）

**関連ファイル:**
- src/pty.c/h: PTY管理、プロセス管理

**テスト:**
- シェルが起動する
- 簡単なコマンド（例: `echo hello`）の出力が読み取れる（printfでデバッグ出力）
- シェルが終了したら検知できる（SIGCHLD）

**実装時間見積もり:** 3-4時間

---

### ステップ1.4: 基本的なテキスト描画
**実装内容:**
- [F3.2] フォントの読み込み（Xft使用）
- [F3.3.2] 固定幅フォントでの文字描画（グリッド配置）
- [F1.4] 固定サイズ (80x24) の文字グリッド
- 基本的な画面バッファ（2次元char配列）

**関連ファイル:**
- src/font.c/h: フォント管理
- src/display.c: テキスト描画
- src/terminal.c/h: 画面バッファ管理

**テスト:**
- 固定文字列をウィンドウに描画できる
- 80x24のグリッドが正しく配置される
- 文字が読める（アンチエイリアス有効）

**実装時間見積もり:** 4-5時間

---

### ステップ1.5: PTY出力を画面に表示
**実装内容:**
- PTYから読んだデータを画面バッファに書き込む
- 画面バッファの内容をウィンドウに描画
- 基本的なカーソル位置管理
- 改行・キャリッジリターンの処理

**関連ファイル:**
- src/terminal.c: バッファ管理、カーソル管理

**テスト:**
- シェルのプロンプトが表示される
- `echo hello` を実行すると "hello" が画面に表示される
- 長い出力が折り返される（単純な折り返し）

**実装時間見積もり:** 3-4時間

---

### ステップ1.6: キーボード入力の基本実装
**実装内容:**
- [F4.1.1] X11からのキーボードイベント取得
- [F4.1.1] ASCII文字のPTYへの送信
- Enter、Backspaceキーの処理

**関連ファイル:**
- src/input.c/h: キーボード入力処理

**テスト:**
- 文字を入力するとシェルに送られる
- Enterでコマンドが実行される
- Backspaceで文字が削除される
- 簡単なコマンド（`ls`, `pwd`, `echo test`）が実行できる

**実装時間見積もり:** 2-3時間

---

### ステップ1.7: VT100基本エスケープシーケンス
**実装内容:**
- [F1.1] 基本的なVT100エスケープシーケンスパーサ
  - カーソル移動（CUP, CUU, CUD, CUF, CUB）
  - 画面クリア（ED, EL）
  - SGR（色とスタイル）の基本
- ステートマシンベースのパーサ実装

**関連ファイル:**
- src/terminal.c: エスケープシーケンスパーサ

**テスト:**
- `clear` コマンドで画面がクリアされる
- `ls --color` で色付き出力が表示される（色は後のフェーズ）
- カーソル位置が正しく変わる

**実装時間見積もり:** 5-6時間

---

### ステップ1.8: MVP統合テストと修正
**実装内容:**
- 統合テスト
- バグ修正
- メモリリーク検証（valgrind）

**テスト:**
- `vim` が起動できる（表示が崩れていても可）
- `htop` が表示される（色はまだ）
- `bash` の基本操作ができる
- メモリリークがない

**実装時間見積もり:** 3-4時間

**フェーズ1合計見積もり:** 25-34時間

---

## フェーズ2: 実用的な機能の追加

### 目標
MVPを実用的なターミナルエミュレータに進化させる。色、リサイズ、スクロールバック、マウス選択など、日常使いに必要な機能を実装する。

---

### ステップ2.1: 16色ANSI対応 ✅ **完了**
**実装内容:**
- [F3.4.1] 16基本ANSI色の実装
  - ANSI 16色パレット定義（Xterm互換）
  - XftColorキャッシュで色管理
- SGRシーケンスの完全実装
  - 前景色: 30-37, 90-97
  - 背景色: 40-47, 100-107
  - 属性: 太字(1), イタリック(3), 下線(4), 反転(7)
  - リセット(0), 個別解除(22-27)
- [F3.3.3] 文字属性のレンダリング
  - 背景色描画
  - 下線描画
  - 反転表示

**関連ファイル:**
- src/terminal.c: SGRパース処理、g_current_attr管理
- src/display.c: ANSI色パレット、色付きレンダリング

**成果物:**
- 16色対応のターミナル
- `ls --color` で色分け表示
- vim のシンタックスハイライト対応

**テスト:**
- `ls --color` で色分けされる
- `vim` のシンタックスハイライトが表示される
- 太字、下線が正しく表示される
- 反転表示が機能する

**実装時間見積もり:** 3-4時間
**実際の実装時間:** 約3時間

---

### ステップ2.2: 特殊キー対応 ✅ **スキップ（フェーズ1で実装済み）**
**実装内容:**
- [F4.1.2] 矢印キー、ファンクションキー、Home/End等
- [F4.1.3] Ctrl, Alt, Shiftの組み合わせ
- 適切なエスケープシーケンスの送信

**関連ファイル:**
- src/input.c: すでにステップ1.6で実装済み

**テスト:**
- `vim` で矢印キーでカーソル移動 ✅
- bashの履歴を↑↓で参照 ✅
- Ctrl+C, Ctrl+Dが正しく動作 ✅

**実装時間見積もり:** 2-3時間
**実際:** 0時間（すでに実装済み）

---

### ステップ2.3: ウィンドウリサイズ対応 ← **次**
**実装内容:**
- [F2.4] ウィンドウサイズ変更の検知
  - ConfigureNotifyイベント処理
  - 新しいウィンドウサイズの計算
- [F2.3] PTYサイズの更新とSIGWINCH送信
  - pty_resize() でPTYサイズ変更
  - ioctl(TIOCSWINSZ) でシェルに通知
- 画面バッファの動的サイズ変更
  - 既存バッファの内容を保持しながらリサイズ
  - 新しいサイズのバッファ確保
- フォントサイズに応じた行数・列数の計算
  - window_width / char_width = cols
  - window_height / char_height = rows

**関連ファイル:**
- src/display.c: ConfigureNotifyイベント処理
- src/terminal.c: terminal_resize() 実装
- src/pty.c: pty_resize() 実装

**成果物:**
- リサイズ可能なターミナルウィンドウ
- シェルが正しくリサイズを認識

**テスト:**
- ウィンドウをリサイズすると表示が追従する
- `echo $COLUMNS $LINES` で正しいサイズが表示される
- リサイズ後も正しく描画される
- vimでリサイズしても表示が崩れない

**実装時間見積もり:** 3-4時間

---

### ステップ2.4: スクロールバックバッファ
**実装内容:**
- [F1.5] スクロールバック履歴バッファ（1000行）
  - リングバッファまたは動的配列で履歴管理
  - 可視領域と履歴の分離
- [F5.4.2] Shift+PageUp/PageDown でスクロール
  - キーボードイベント処理
  - スクロールオフセット管理
- [F5.4.3] マウスホイールでスクロール
  - ButtonPressイベント（Button4/5）処理
  - スムーズスクロール
- 履歴表示モードとライブモードの切り替え
  - スクロール中は新規出力を自動スクロールしない
  - 最下行に戻ると自動スクロール再開

**関連ファイル:**
- src/terminal.c/h: スクロールバックバッファ実装
- src/input.c: Shift+PageUp/PageDown処理
- src/display.c: マウスホイールイベント処理

**成果物:**
- 1000行のスクロールバック履歴
- キーボードとマウスでスクロール可能

**テスト:**
- 長い出力（`dmesg`, `cat large_file.txt`）が履歴に残る
- Shift+PageUpで過去の出力を見られる
- マウスホイールでスクロールできる
- 新しい出力があると自動的に下にスクロール
- `seq 1000` の出力が全て履歴に残る

**実装時間見積もり:** 4-5時間

---

### ステップ2.5: マウス選択とクリップボード
**実装内容:**
- [F4.2.1] マウスでのテキスト選択
  - ButtonPressイベントで選択開始
  - MotionNotifyイベントで選択範囲更新
  - ButtonReleaseイベントで選択確定
- [F5.1.1] 選択範囲のハイライト表示
  - 選択セルの背景色反転
  - 複数行選択対応
- [F4.2.2] Ctrl+Shift+C でコピー
  - 選択テキストをCLIPBOARDにコピー
- [F4.2.3] Ctrl+Shift+V でペースト
  - CLIPBOARDからテキスト取得
  - PTYに送信
- [F5.2.2] 中クリックペースト
  - Button2でPRIMARYからペースト
- X11クリップボード統合（PRIMARY, CLIPBOARD）
  - XSetSelectionOwner
  - SelectionRequestイベント処理

**関連ファイル:**
- src/display.c: マウスイベント処理、選択範囲描画
- src/input.c: Ctrl+Shift+C/V処理
- src/selection.c/h: 新規作成、クリップボード管理

**成果物:**
- マウスでテキスト選択可能
- X11クリップボード統合

**テスト:**
- マウスドラッグでテキスト選択
- 選択したテキストがクリップボードにコピーされる
- 他のアプリケーションからペーストできる
- 中クリックでペーストできる
- 複数行選択が正しく動作

**実装時間見積もり:** 4-5時間

---

### ステップ2.6: 256色サポート
**実装内容:**
- [F1.2] xterm-256color対応
  - TERM環境変数の設定
- [F3.4.2] 256色パレットの実装
  - 16基本色 + 216キューブ色 + 24グレースケール
  - パレット自動生成
- 256色SGRシーケンスの解析
  - ESC[38;5;Nm (256色前景)
  - ESC[48;5;Nm (256色背景)

**関連ファイル:**
- src/display.c: 256色パレット初期化
- src/terminal.c: SGRパーサー拡張

**成果物:**
- 256色対応ターミナル
- xterm-256color互換

**テスト:**
- `TERM=xterm-256color` で起動
- 256色テストスクリプトで全色表示される
- `vim` の高度なカラースキームが使える
- グラデーション表示が滑らか

**実装時間見積もり:** 2-3時間

---

### ステップ2.7: VT100完全互換性
**実装内容:**
- [F1.1] VT100/VT102の完全実装
- 未実装のエスケープシーケンスの追加
  - ICH, DCH, IL, DL (挿入・削除)
  - SM, RM (モード設定)
  - DECSTBM (スクロール領域設定)
- 代替スクリーンバッファ
  - ESC[?1049h/l で切り替え
  - vim, lessで使用
- スクロール領域の設定
  - 上下マージン設定

**関連ファイル:**
- src/terminal.c: エスケープシーケンス追加
- src/terminal.h: 代替バッファ構造

**成果物:**
- VT100完全互換ターミナル
- 代替スクリーンバッファ対応

**テスト:**
- `vim`, `less`, `htop` が完全に動作
- vttest（VT100互換性テストツール）を実行
- 画面分割が正しく動作
- vim終了時に元の画面に戻る

**実装時間見積もり:** 5-6時間

---

### ステップ2.8: フェーズ2統合テスト
**実装内容:**
- 各機能の統合テスト
  - 色、リサイズ、スクロール、選択の組み合わせ
- パフォーマンス測定
  - 大量出力時のFPS
  - メモリ使用量
- バグ修正
  - エッジケースの処理
  - メモリリーク修正

**関連ファイル:**
- 全ファイル

**成果物:**
- 安定した実用的ターミナルエミュレータ

**テスト:**
- 一般的なCLIツールが全て動作（vim, emacs, htop, tmux等）
- リサイズ、スクロール、選択が安定動作
- メモリリークがない
- 長時間使用しても安定
- `cat /var/log/syslog` で大量出力に耐える

**実装時間見積もり:** 4-5時間

**フェーズ2合計見積もり:** 27-35時間
**実際の進捗:** 2/8ステップ完了 (25%)

---

## フェーズ3: 洗練と最適化

### ステップ3.1: 設定ファイルサポート
**実装内容:**
- INI形式の設定ファイル読み込み
- デフォルト設定の定義
- 実行時設定の適用

**関連ファイル:**
- src/config.c/h: 設定管理

**テスト:**
- `~/.config/koteiterm/koteiterm.conf` が読み込まれる
- フォントサイズ、色、動作設定が反映される
- 設定ファイルがなくてもデフォルトで動作

**実装時間見積もり:** 3-4時間

---

### ステップ3.2: カーソルスタイルと点滅
**実装内容:**
- [F3.5] カーソルスタイル（ブロック、アンダーライン、ビーム）
- [F3.6] カーソル点滅のアニメーション
- エスケープシーケンスでのスタイル変更対応

**テスト:**
- 各カーソルスタイルが表示される
- カーソルが点滅する（設定で無効化可能）
- アプリケーションがカーソルスタイルを変更できる

**実装時間見積もり:** 2-3時間

---

### ステップ3.3: UTF-8とマルチバイト文字対応
**実装内容:**
- [F1.3] UTF-8文字列の正しい処理
- 日本語・中国語等のワイド文字（2セル幅）対応
- 結合文字の処理

**テスト:**
- 日本語が正しく表示される
- ワイド文字が2セル分の幅で表示される
- 絵文字が表示される
- `echo "こんにちは世界"` が正しく表示される

**実装時間見積もり:** 4-5時間

---

### ステップ3.4: トゥルーカラー対応
**実装内容:**
- [F3.4.3] 24ビットRGBカラーサポート
- SGR 38;2;r;g;b および 48;2;r;g;b シーケンス

**テスト:**
- トゥルーカラー対応のアプリケーションで正しく表示
- グラデーション表示が滑らか

**実装時間見積もり:** 2-3時間

---

### ステップ3.5: パフォーマンス最適化
**実装内容:**
- ダーティ領域管理の最適化
- 不要な再描画の削減
- バッファリングの改善
- プロファイリングとボトルネック解消

**テスト:**
- `cat large_file.txt` の表示が高速
- CPU使用率が低い
- 60FPS以上のレンダリング
- 入力レイテンシ < 10ms

**実装時間見積もり:** 5-6時間

---

### ステップ3.6: メモリ管理の最適化
**実装内容:**
- メモリプールの導入
- 不要なアロケーションの削減
- スクロールバックバッファの効率化

**テスト:**
- メモリ使用量 < 50MB
- 長時間実行してもメモリリークなし
- valgrindでエラーなし

**実装時間見積もり:** 3-4時間

---

### ステップ3.7: エラーハンドリングと安定性向上
**実装内容:**
- エラー処理の徹底
- 異常系のテスト
- シグナル処理の改善
- クラッシュ時の安全な終了

**テスト:**
- シェルが異常終了しても安定
- X11接続エラーで適切にエラー表示
- 巨大な入力でもクラッシュしない

**実装時間見積もり:** 3-4時間

---

### ステップ3.8: IME対応（基本）
**実装内容:**
- [F4.1.4] X11 XIM（Input Method）統合
- 日本語入力のサポート
- インライン変換表示（基本）

**テスト:**
- 日本語IMEで入力できる
- 変換候補が表示される
- 確定した文字が正しく入力される

**実装時間見積もり:** 5-6時間

---

### ステップ3.9: フェーズ3統合テスト
**実装内容:**
- 全機能の統合テスト
- パフォーマンスベンチマーク
- 長時間安定性テスト

**実装時間見積もり:** 4-5時間

**フェーズ3合計見積もり:** 31-40時間

---

## フェーズ4: 高度な機能（将来実装）

このフェーズは基本機能が安定してから着手します。

### ステップ4.1: URL検出とクリック
**実装内容:**
- [F5.3] URL自動検出
- Ctrl+クリックでブラウザ起動

**実装時間見積もり:** 3-4時間

---

### ステップ4.2: 矩形選択
**実装内容:**
- [F5.1.3] Alt+ドラッグで矩形選択

**実装時間見積もり:** 2-3時間

---

### ステップ4.3: マウスレポート
**実装内容:**
- [F4.2.4] アプリケーションへのマウスイベント送信

**実装時間見積もり:** 2-3時間

---

### ステップ4.4: スクロールバー表示
**実装内容:**
- [F5.4.1] オプションのスクロールバー

**実装時間見積もり:** 2-3時間

---

### ステップ4.5: フォント選択とスケーリング
**実装内容:**
- 実行時のフォント変更
- Ctrl+マウスホイールでフォントサイズ変更

**実装時間見積もり:** 3-4時間

---

### ステップ4.6: タブサポート
**実装内容:**
- 複数ターミナルのタブ表示
- タブの追加・削除・切り替え

**実装時間見積もり:** 8-10時間

---

### ステップ4.7: 分割ペイン
**実装内容:**
- 水平・垂直分割
- ペイン間の移動

**実装時間見積もり:** 10-12時間

---

### ステップ4.8: テーマとカスタマイズ
**実装内容:**
- カラーテーマのプリセット
- カスタムキーバインディング
- 透過対応

**実装時間見積もり:** 5-6時間

**フェーズ4合計見積もり:** 35-45時間

---

## テスト戦略

### ユニットテスト
各コンポーネントごとのテスト:
- **VT100パーサ**: 各エスケープシーケンスの解析
- **PTY処理**: 入出力の正確性
- **画面バッファ**: カーソル移動、文字書き込み
- **設定ファイル**: パース処理

テストフレームワーク: Check または Unity

### 統合テスト
実際のアプリケーションでのテスト:
- `vim` - カーソル移動、編集、カラー表示
- `htop` - リアルタイム更新、色
- `less` - スクロール、検索
- `tmux` - 代替スクリーンバッファ
- `emacs` - 複雑な表示
- `vttest` - VT100互換性テスト

### パフォーマンステスト
- 大量出力: `cat /var/log/syslog`
- 高速更新: `yes | head -10000`
- メモリ使用量: 長時間実行
- CPU使用率: アイドル時と高負荷時

### 手動テスト
日常的な使用シナリオ:
- コーディング作業（vim/emacs）
- ログ監視（tail -f）
- システム管理（htop, top）
- 日本語入力
- コピー&ペースト作業

---

## 実装スケジュール概算

| フェーズ | 内容 | 見積もり時間 | 累積時間 |
|---------|------|------------|---------|
| フェーズ1 | MVP | 25-34h | 25-34h |
| フェーズ2 | 実用機能 | 27-35h | 52-69h |
| フェーズ3 | 洗練・最適化 | 31-40h | 83-109h |
| フェーズ4 | 高度な機能 | 35-45h | 118-154h |

**実働日数換算（1日4時間作業）:**
- フェーズ1完了まで: 約6-9日
- フェーズ2完了まで: 約13-18日
- フェーズ3完了まで: 約21-28日
- フェーズ4完了まで: 約30-39日

---

## 依存関係マップ

```
ステップ1.1 (基盤)
    ↓
ステップ1.2 (X11) ←┐
    ↓              │
ステップ1.4 (描画) │
    ↓              │
ステップ1.5 (表示) │
    ↓              │
ステップ1.3 (PTY)──┘
    ↓
ステップ1.6 (入力)
    ↓
ステップ1.7 (VT100)
    ↓
ステップ1.8 (統合)
    ↓
フェーズ2以降（順次）
```

---

## リスク管理

### 高リスク項目
1. **VT100エスケープシーケンスの完全実装**
   - 複雑で、仕様の解釈が難しい
   - 緩和策: 段階的実装、vttestでの検証

2. **UTF-8とワイド文字の処理**
   - エッジケースが多い
   - 緩和策: 既存実装（xterm等）を参考

3. **パフォーマンス目標の達成**
   - 大量データ処理時のレイテンシ
   - 緩和策: 早期のプロファイリング、最適化

4. **IME統合**
   - X11 XIMの複雑さ
   - 緩和策: 基本機能から段階的実装

### 中リスク項目
- クリップボード統合の不具合
- マウス選択の細かい動作
- ウィンドウリサイズ時の描画崩れ

---

## 次のステップ

1. **ステップ1.1から順次実装開始**
2. 各ステップ完了後、必ずテストを実行
3. 問題があれば実装計画を見直し
4. フェーズ1完了時点で全体の進捗を評価
