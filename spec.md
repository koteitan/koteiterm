# koteiterm - Linuxターミナルエミュレータ仕様書

## 概要
xtermに似た、Linux（WSL）環境向けのモダンなターミナルエミュレータ。シェルとの対話的操作のためのグラフィカルインターフェースを提供する。

## 対象環境
- **プラットフォーム**: Linux (WSL2)
- **ディスプレイサーバ**: X11 または Wayland
- **プログラミング言語**: C/C++（パフォーマンスと互換性のため推奨）
- **アーキテクチャ**: ネイティブLinuxアプリケーション

## コア機能

### 1. ターミナルエミュレーション
- **[F1.1] VT100/VT102互換性**: 基本的なANSIエスケープシーケンスのサポート
- **[F1.2] xterm-256colorサポート**: 256色パレット
- **[F1.3] UTF-8エンコーディング**: 国際文字の完全なUnicodeサポート
- **[F1.4] ターミナルサイズ**: 行数と列数の設定可能（デフォルト: 80x24）
- **[F1.5] スクロールバックバッファ**: 履歴の設定可能（デフォルト: 1000行）

### 2. シェル統合
- **[F2.1] PTY（疑似端末）サポート**: PTYを使用したシェルプロセスのfork/exec
- **[F2.2] デフォルトシェル**: $SHELL環境変数から読み取り（フォールバック: /bin/bash）
- **[F2.3] シグナル処理**: SIGCHLD、SIGWINCHの適切な処理
- **[F2.4] ウィンドウリサイズ**: ターミナルサイズの変更をシェルに通知

### 3. ユーザーインターフェース
- **[F3.1] ウィンドウマネージャ**: X11/Waylandを使用したウィンドウ作成
- **[F3.2] フォントレンダリング**: サイズ設定可能な等幅フォント
- **[F3.3] テキストレンダリング**:
  - [F3.3.1] アンチエイリアスされたテキスト描画
  - [F3.3.2] 適切な文字セルアラインメント
  - [F3.3.3] 太字、斜体、下線のサポート
- **[F3.4] 色サポート**:
  - [F3.4.1] 16基本ANSI色
  - [F3.4.2] 256色パレット
  - [F3.4.3] トゥルーカラー（24ビットRGB）サポート
- **[F3.5] カーソルスタイル**: ブロック、アンダーライン、ビーム（設定可能）
- **[F3.6] カーソル点滅**: on/off設定可能

### 4. 入力処理
- **[F4.1] キーボード入力**:
  - [F4.1.1] 標準ASCII文字
  - [F4.1.2] 特殊キー（矢印キー、ファンクションキーなど）
  - [F4.1.3] 修飾キー（Ctrl、Alt、Shiftの組み合わせ）
  - [F4.1.4] アジア言語のIMEサポート
- **[F4.2] マウス入力**:
  - [F4.2.1] マウスによるテキスト選択
  - [F4.2.2] クリップボードへのコピー
  - [F4.2.3] クリップボードからのペースト
  - [F4.2.4] アプリケーションへのマウスレポート（オプション）

### 5. 表示機能
- **[F5.1] テキスト選択**:
  - [F5.1.1] マウスベースの選択
  - [F5.1.2] 選択時自動コピー（オプション）
  - [F5.1.3] 矩形選択（Alt+ドラッグ）
- **[F5.2] クリップボード統合**:
  - [F5.2.1] Ctrl+Shift+C/Vでコピー/ペースト
  - [F5.2.2] 中クリックペースト
- **[F5.3] URL検出**: クリック可能なURL（Ctrl+クリックで開く）
- **[F5.4] スクロール**:
  - [F5.4.1] スクロールバー（オプション）
  - [F5.4.2] Shift+PageUp/PageDown
  - [F5.4.3] マウスホイールサポート

## 技術アーキテクチャ

### コンポーネント構成
```
koteiterm/
├── src/
│   ├── main.c              # エントリポイント、初期化
│   ├── terminal.c/h        # ターミナルエミュレータコア（VTパーサ）
│   ├── pty.c/h             # PTY処理、シェルプロセス管理
│   ├── display.c/h         # X11/Waylandウィンドウとレンダリング
│   ├── font.c/h            # フォント読み込みとテキスト描画
│   ├── input.c/h           # キーボードとマウス入力処理
│   ├── config.c/h          # 設定管理
│   └── utils.c/h           # ユーティリティ関数
├── include/
│   └── koteiterm.h         # 共通ヘッダと定義
├── config/
│   └── koteiterm.conf      # デフォルト設定ファイル
├── tests/
│   └── (ユニットテスト)
├── docs/
│   └── README.md
├── Makefile
└── spec.md (このファイル)
```

### 依存関係
- **libX11**: X11ウィンドウ管理
- **libXft** または **libfreetype**: フォントレンダリング
- **libfontconfig**: フォント検索
- **libutil**: PTYユーティリティ（openpty、forkpty）
- **libpthread**: スレッドサポート（オプション、レンダリング用）

### 主要アルゴリズム

#### VT100エスケープシーケンスパーサ
- ステートマシンベースのパーサ
- CSI（Control Sequence Introducer）シーケンスの処理
- SGR（Select Graphic Rendition）カラー/スタイルコードのサポート
- カーソル移動コマンド
- 画面操作（クリア、スクロール）

#### PTY通信
```
親プロセス (koteiterm)  ←→  PTY マスタ
                                 ↕
                             PTY スレーブ  ←→  子プロセス (shell)
```

#### レンダリングパイプライン
1. PTYマスタからデータを読み取る
2. エスケープシーケンスを解析してターミナル状態を更新
3. 内部スクリーンバッファ（2D文字配列）を更新
4. 変更された領域をX11ウィンドウに描画
5. vsyncとリフレッシュレートを処理

## 設定

### 設定ファイル形式
- 場所: `~/.config/koteiterm/koteiterm.conf` または `/etc/koteiterm/koteiterm.conf`
- 形式: INI形式またはシンプルなキー・バリューペア

### 設定可能パラメータ
```ini
[terminal]
rows = 24
columns = 80
scrollback = 1000
shell = /bin/bash

[appearance]
font = monospace
font_size = 12
cursor_style = block
cursor_blink = true

[colors]
foreground = #ffffff
background = #000000
color0 = #000000
color1 = #cc0000
; ... (16色)

[behavior]
copy_on_select = false
scrollbar = true
url_click = true
```

## 開発フェーズ

### フェーズ1: 最小実用製品（MVP）
- 基本的なPTY作成とシェル実行
- 基本的なテキスト描画を持つシンプルなX11ウィンドウ
- VT100エスケープシーケンス解析（サブセット）
- 基本的なキーボード入力
- 固定80x24ターミナルサイズ

### フェーズ2: 拡張機能
- 完全なVT100/xterm互換性
- 256色サポート
- ウィンドウリサイズ
- スクロールバックバッファ
- テキスト選択とクリップボード

### フェーズ3: 洗練と最適化
- 設定ファイルサポート
- フォント選択とスケーリング
- パフォーマンス最適化
- IMEサポート
- URL検出とクリック

### フェーズ4: 高度な機能
- タブサポート（複数ターミナル）
- 分割ペイン
- 透過とコンポジティング
- カスタムキーバインディング
- テーマと外観カスタマイズ

## テスト戦略
- **ユニットテスト**: 個別コンポーネントのテスト（パーサ、PTY処理）
- **統合テスト**: 既知のエスケープシーケンスでターミナル出力をテスト
- **手動テスト**: 一般的なプログラムを実行（vim、htop、lessなど）
- **互換性テスト**: xtermの動作と比較

## パフォーマンス目標
- **起動時間**: < 100ms
- **入力レイテンシ**: < 10ms
- **レンダリング**: 最低60 FPS
- **メモリ使用量**: 単一ターミナルインスタンスで < 50MB

## 標準と参考資料
- **ECMA-48**: Control Functions for Coded Character Sets
- **VT100 User Guide**: DEC VT100ターミナル仕様
- **xterm control sequences**: https://invisible-island.net/xterm/ctlseqs/ctlseqs.html
- **POSIX PTY**: IEEE Std 1003.1疑似端末仕様

## 将来的な検討事項
- Waylandネイティブサポート（X11に加えて）
- GPUアクセラレーション描画（OpenGL/Vulkan）
- Sixelグラフィックサポート
- プログラミングフォントのリガチャサポート
- プラグイン用の拡張API

## ライセンス
未定（MITまたはGPLを推奨）
